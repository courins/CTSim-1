clear all;
close all;

addpath('../UtilityFunctions')
for ii = 1:5
data = load( strcat('burn_0',num2str(ii)))
imgKr = data.img;

data = load( 'air_hot_02.mat');
imgAir = data.img;

clear data;
saveind = 0;

%% image registration, you may skip this step

imgKrReg = imgKr;

% [optimizer, metric] = imregconfig('monomodal');
% for i = 1 : size( imgAir, 3 )
%     if mod(i, 50) == 0
%         fprintf('(%i/%i)... ', i, size(imgAir, 3 ) );
%     end
%     slice = imregister(imgKr(:,:,i), imgAir(:, :, i), 'rigid', optimizer, metric);
%     imgKrReg( :,:,i) = slice;
% end
 
 figure(23); imdisp( imgKr(:,end/2,:));

%% Get image pixel that are not gas

imgSub = imgKrReg - imgAir;

% segmentation
solid = imgAir > 0.15;
solid = solid | imgKr > 0.15;

% mophological blurring in all dimension
final = solid;
solid_blurred = solid; 

% in x direction
for i = 1 : size( imgAir, 1 )
    solid_blurred( i, :, : ) = imdilate( solid(i,:,:) , ones(3) ); 
end
final = final | solid_blurred;

% in y direction
for i = 1 : size( imgAir, 1 )
    solid_blurred( :, i, : ) = imdilate( solid(:,i,:) , ones(3) ); 
end
final = final | solid_blurred;

% in z direction
for i = 1 : size( imgAir, 3 )
    solid_blurred( :, :, i ) = imdilate( solid(:,:,i) , ones(3) ); 
end
final = final | solid_blurred;

final = final | abs( imgSub ) > 0.04;

% for slices that have porous media below system resolution
 final( :, :, 370 : end ) = false;


%% Now let's compute average density for each slice
close all;

% bounding box with the
%x = [123 284];
%y = [180 290];

x = [120 260];
y = [120 260];
%x = [140 240];
%y = [140 240];

%final( 120:140,120:140,:) = true;

att_curve = zeros( 1, size( imgAir, 3));

for i = 1 : length( att_curve )
    
    slice = imgSub(x(1):x(2), y(1):y(2),i);
    valid =  ~final( x(1):x(2), y(1):y(2),i);
    
    att_curve(i) = mean( slice( valid(:) ) );
    
end

figure; plot( att_curve ); 
xlabel 'slice #', ylabel 'attenuation';

figure;
imagesc( squeeze( imgSub(:,end/2,:) )' , [-0.01 0.02] ); axis image

figure;
slice = imgSub(:,end/2,:);
slice( final(:,end/2,:) ) = 0;
imagesc( squeeze( slice )' , [-0.01 0.02] ); axis image

att_curve_mat(ii,:) = att_curve;
end


%%
figure;
slice = imgSub(:,:,300);
slice( final(:,:,300) ) = 0;

imagesc(slice , [-0.01 0.02] ); 

figure;
slice = imgSub(:,:,275);
slice( final(:,:,275) ) = 0;

imagesc(slice , [-0.01 0.02] ); 

figure;
slice = imgSub(:,:,250);
slice( final(:,:,250) ) = 0;

imagesc(slice , [-0.01 0.02] );

%% Loading XML Model Data
%addpath('../ModelResults'); %folder with model results
%s = xml2struct('Casephi_0.6106u0_0.2738_INITIAL_CASE_500_Kr.xml')

%copied and pasted from python console...find a way to make this more
%user-friendly
fT = [ 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000000e+02 2.980000000001e+02 2.980000000001e+02 2.980000000001e+02 2.980000000001e+02 2.980000000001e+02 2.980000000001e+02 2.980000000002e+02 2.980000000002e+02 2.980000000002e+02 2.980000000002e+02 2.980000000003e+02 2.980000000003e+02 2.980000000004e+02 2.980000000005e+02 2.980000000005e+02 2.980000000006e+02 2.980000000008e+02 2.980000000009e+02 2.980000000010e+02 2.980000000012e+02 2.980000000014e+02 2.980000000017e+02 2.980000000020e+02 2.980000000023e+02 2.980000000027e+02 2.980000000032e+02 2.980000000037e+02 2.980000000043e+02 2.980000000051e+02 2.980000000060e+02 2.980000000070e+02 2.980000000082e+02 2.980000000096e+02 2.980000000113e+02 2.980000000132e+02 2.980000000155e+02 2.980000000181e+02 2.980000000212e+02 2.980000000248e+02 2.980000000291e+02 2.980000000341e+02 2.980000000399e+02 2.980000000467e+02 2.980000000547e+02 2.980000000640e+02 2.980000000750e+02 2.980000000878e+02 2.980000001028e+02 2.980000001203e+02 2.980000001408e+02 2.980000001649e+02 2.980000001930e+02 2.980000002258e+02 2.980000002643e+02 2.980000003093e+02 2.980000003620e+02 2.980000004235e+02 2.980000004956e+02 2.980000005798e+02 2.980000006784e+02 2.980000007936e+02 2.980000009284e+02 2.980000010859e+02 2.980000012702e+02 2.980000014856e+02 2.980000017375e+02 2.980000020319e+02 2.980000023761e+02 2.980000027784e+02 2.980000032487e+02 2.980000037983e+02 2.980000044405e+02 2.980000051911e+02 2.980000060682e+02 2.980000070929e+02 2.980000082902e+02 2.980000096890e+02 2.980000113229e+02 2.980000132316e+02 2.980000154609e+02 2.980000180646e+02 2.980000211052e+02 2.980000246559e+02 2.980000288020e+02 2.980000336427e+02 2.980000392942e+02 2.980000458917e+02 2.980000535928e+02 2.980000625816e+02 2.980000730723e+02 2.980000853151e+02 2.980000996012e+02 2.980001162702e+02 2.980001357180e+02 2.980001584058e+02 2.980001848710e+02 2.980002157398e+02 2.980002517414e+02 2.980002937255e+02 2.980003426816e+02 2.980003997620e+02 2.980004663083e+02 2.980005438829e+02 2.980006343040e+02 2.980007396885e+02 2.980008624996e+02 2.980010056040e+02 2.980011723370e+02 2.980013665788e+02 2.980015928426e+02 2.980018563778e+02 2.980021632884e+02 2.980025206715e+02 2.980029367776e+02 2.980034211964e+02 2.980039850728e+02 2.980046413565e+02 2.980054050919e+02 2.980062937541e+02 2.980073276379e+02 2.980085303088e+02 2.980099291242e+02 2.980115558387e+02 2.980134473024e+02 2.980156462709e+02 2.980182023407e+02 2.980211730315e+02 2.980246250373e+02 2.980286356721e+02 2.980332945394e+02 2.980387054608e+02 2.980449887013e+02 2.980522835377e+02 2.980607512200e+02 2.980705783864e+02 2.980819809971e+02 2.980952088664e+02 2.981105508792e+02 2.981283409934e+02 2.981489651420e+02 2.981728691662e+02 2.982005679266e+02 2.982326557630e+02 2.982698184915e+02 2.983128471580e+02 2.983626537920e+02 2.984202894378e+02 2.984869647759e+02 2.985640736863e+02 2.986532201481e+02 2.987562489184e+02 2.988752804864e+02 2.990127508538e+02 2.991714567567e+02 2.993546070099e+02 2.995658807259e+02 2.998094932367e+02 3.000902706256e+02 3.004137338568e+02 3.007861935743e+02 3.012148567192e+02 3.017079461925e+02 3.022748348540e+02 3.029261951991e+02 3.036741660774e+02 3.045325378090e+02 3.055169569851e+02 3.066451521016e+02 3.079371809274e+02 3.094157001142e+02 3.111062569540e+02 3.130376023031e+02 3.152420224139e+02 3.177556855840e+02 3.206189969566e+02 3.238769511958e+02 3.275794677298e+02 3.317816863026e+02 3.365441909831e+02 3.419331175939e+02 3.480200813183e+02 3.548818356498e+02 3.625995361562e+02 3.712574215723e+02 3.809406111958e+02 3.917314710041e+02 4.037033993487e+02 4.169093191048e+02 4.313579973934e+02 4.469601734708e+02 4.633967395377e+02 4.797815201251e+02 4.937717549084e+02 5.060815138819e+02 5.172885180906e+02 5.277067538944e+02 5.375262447525e+02 5.468710786370e+02 5.558264799002e+02 5.644525962034e+02 5.727920509677e+02 5.808744950469e+02 5.887200173536e+02 5.963430396307e+02 6.037589657806e+02 6.109976947427e+02 6.181320826696e+02 6.253375177713e+02 6.329212229799e+02 6.408878795897e+02 6.492445708977e+02 6.580022431261e+02 6.671786669630e+02 6.768042943798e+02 6.869337420082e+02 6.976682028235e+02 7.091989507706e+02 7.218910744522e+02 7.364423801707e+02 7.541776955900e+02 7.775704548765e+02 8.110920460393e+02 8.623656963382e+02 9.430610472286e+02 1.067379965461e+03 1.241488888971e+03 1.429069463254e+03 1.536029684915e+03 1.579978161373e+03 1.605721484816e+03 1.624550315550e+03 1.638984228320e+03 1.650098685808e+03 1.658630834775e+03 1.665143284726e+03 1.670071444232e+03 1.673753400338e+03 1.676452743219e+03 1.678376021205e+03 1.679685944589e+03 1.680511341747e+03 1.680954684511e+03 1.681097806363e+03 1.681006275962e+03 1.680732765585e+03 1.680319663671e+03 1.679801114916e+03 1.679204623801e+03 1.678552322838e+03 1.677861981592e+03 1.677147813942e+03 1.676421127352e+03 1.675690847644e+03 1.674963945126e+03 1.674245782092e+03 1.673540397349e+03 1.672850739995e+03 1.672178862142e+03 1.671526078238e+03 1.670893097082e+03 1.670280131434e+03 1.669686989142e+03 1.669113148955e+03 1.668557823621e+03 1.668020012356e+03 1.667498544411e+03 1.666992115160e+03 1.666499315881e+03 1.666018658201e+03 1.665548594019e+03 1.665087531588e+03 1.664633848333e+03 1.664185900876e+03 1.663742032693e+03 1.663300579744e+03 1.662859874362e+03 1.662418247677e+03 1.661974030770e+03 1.661525554742e+03 1.661071149874e+03 1.660609143979e+03 1.660137860093e+03 1.659655613572e+03 1.659160708692e+03 1.658651434814e+03 1.658126062179e+03 1.657582837374e+03 1.657019978523e+03 1.656435670240e+03 1.655828058396e+03 1.655195244726e+03 1.654535281346e+03 1.653846165215e+03 1.653125832620e+03 1.652372153748e+03 1.651582927447e+03 1.650755876271e+03 1.649888641940e+03 1.648978781362e+03 1.648023763373e+03 1.647020966408e+03 1.645967677291e+03 1.644861091401e+03 1.643698314470e+03 1.642476366283e+03 1.641192186576e+03 1.639842643445e+03 1.638424544543e+03 1.636934651369e+03 1.635369696910e+03 1.633726406847e+03 1.632001524500e+03 1.630191839568e+03 1.628294220651e+03 1.626305651381e+03 1.624223269844e+03 1.622044410796e+03 1.619766649976e+03 1.617387849603e+03 1.614906203957e+03 1.612320283721e+03 1.609629077602e+03 1.606832029646e+03 1.603929070596e+03 1.600920641670e+03 1.597807709305e+03 1.594591769639e+03 1.591274841852e+03 1.587859449983e+03 1.584348593312e+03 1.580745705985e+03 1.577054607108e+03 1.573279442995e+03 1.569424623657e+03 1.565494755849e+03 1.561494575078e+03 1.557428878880e+03 1.553302463467e+03 1.549120065488e+03 1.544886310259e+03 1.540605667342e+03 1.536282413949e+03 1.531920606220e+03 1.527524058128e+03 1.523096327461e+03 1.518640708191e+03 1.514160228396e+03 1.509657652887e+03 1.505135489667e+03 1.500595999422e+03 1.496041207298e+03 1.491472916309e+03 1.486892721829e+03 1.482302026691e+03 1.477702056543e+03 1.473093875157e+03 1.468478399499e+03 1.463856414399e+03 1.459228586748e+03 1.454595479159e+03 1.449957563115e+03 1.445315231590e+03 1.440668811227e+03 1.436018574111e+03 1.431364749242e+03 1.426707533769e+03 1.422047104123e+03 1.417383627113e+03 1.412717271142e+03 1.408048217622e+03 1.403376672750e+03 1.398702879746e+03 1.394027131723e+03 1.389349785317e+03 1.384671275283e+03 1.379992130228e+03 1.375312989743e+03 1.370634623246e+03 1.365957950945e+03 1.361284067540e+03 1.356614269548e+03 1.351950087679e+03 1.347293326507e+03 1.342646115188e+03 1.338010975443e+03 1.333390917323e+03 1.328789580674e+03 1.324211452884e+03 1.319662215417e+03 1.315149309442e+03 1.310682876136e+03 1.306277340099e+03 1.301954099382e+03 1.297746122685e+03 1.293705836000e+03 1.289918682363e+03 1.286526453288e+03 1.283767400148e+03 1.282044986714e+03 1.282044986714e+03 ];
fz = [ 0.000000000000e+00 2.540000000000e-04 5.080000000000e-04 7.620000000000e-04 1.016000000000e-03 1.270000000000e-03 1.524000000000e-03 1.778000000000e-03 2.032000000000e-03 2.286000000000e-03 2.540000000000e-03 2.794000000000e-03 3.048000000000e-03 3.302000000000e-03 3.556000000000e-03 3.810000000000e-03 4.064000000000e-03 4.318000000000e-03 4.572000000000e-03 4.826000000000e-03 5.080000000000e-03 5.334000000000e-03 5.588000000000e-03 5.842000000000e-03 6.096000000000e-03 6.350000000000e-03 6.604000000000e-03 6.858000000000e-03 7.112000000000e-03 7.366000000000e-03 7.620000000000e-03 7.874000000000e-03 8.128000000000e-03 8.382000000000e-03 8.636000000000e-03 8.890000000000e-03 9.144000000000e-03 9.398000000000e-03 9.652000000000e-03 9.906000000000e-03 1.016000000000e-02 1.041400000000e-02 1.066800000000e-02 1.092200000000e-02 1.117600000000e-02 1.143000000000e-02 1.168400000000e-02 1.193800000000e-02 1.219200000000e-02 1.244600000000e-02 1.270000000000e-02 1.295400000000e-02 1.320800000000e-02 1.346200000000e-02 1.371600000000e-02 1.397000000000e-02 1.422400000000e-02 1.447800000000e-02 1.473200000000e-02 1.498600000000e-02 1.524000000000e-02 1.549400000000e-02 1.574800000000e-02 1.600200000000e-02 1.625600000000e-02 1.651000000000e-02 1.676400000000e-02 1.701800000000e-02 1.727200000000e-02 1.752600000000e-02 1.778000000000e-02 1.803400000000e-02 1.828800000000e-02 1.854200000000e-02 1.879600000000e-02 1.905000000000e-02 1.930400000000e-02 1.955800000000e-02 1.981200000000e-02 2.006600000000e-02 2.032000000000e-02 2.057400000000e-02 2.082800000000e-02 2.108200000000e-02 2.133600000000e-02 2.159000000000e-02 2.184400000000e-02 2.209800000000e-02 2.235200000000e-02 2.260600000000e-02 2.286000000000e-02 2.311400000000e-02 2.336800000000e-02 2.362200000000e-02 2.387600000000e-02 2.413000000000e-02 2.438400000000e-02 2.463800000000e-02 2.489200000000e-02 2.514600000000e-02 2.540000000000e-02 2.552700000000e-02 2.565400000000e-02 2.578100000000e-02 2.590800000000e-02 2.603500000000e-02 2.616200000000e-02 2.628900000000e-02 2.641600000000e-02 2.654300000000e-02 2.667000000000e-02 2.679700000000e-02 2.692400000000e-02 2.705100000000e-02 2.717800000000e-02 2.730500000000e-02 2.743200000000e-02 2.755900000000e-02 2.768600000000e-02 2.781300000000e-02 2.794000000000e-02 2.806700000000e-02 2.819400000000e-02 2.832100000000e-02 2.844800000000e-02 2.857500000000e-02 2.870200000000e-02 2.882900000000e-02 2.895600000000e-02 2.908300000000e-02 2.921000000000e-02 2.933700000000e-02 2.946400000000e-02 2.959100000000e-02 2.971800000000e-02 2.984500000000e-02 2.997200000000e-02 3.009900000000e-02 3.022600000000e-02 3.035300000000e-02 3.048000000000e-02 3.060700000000e-02 3.073400000000e-02 3.086100000000e-02 3.098800000000e-02 3.111500000000e-02 3.124200000000e-02 3.136900000000e-02 3.149600000000e-02 3.162300000000e-02 3.175000000000e-02 3.187700000000e-02 3.200400000000e-02 3.213100000000e-02 3.225800000000e-02 3.238500000000e-02 3.251200000000e-02 3.263900000000e-02 3.276600000000e-02 3.289300000000e-02 3.302000000000e-02 3.314700000000e-02 3.327400000000e-02 3.340100000000e-02 3.352800000000e-02 3.365500000000e-02 3.378200000000e-02 3.390900000000e-02 3.403600000000e-02 3.416300000000e-02 3.429000000000e-02 3.441700000000e-02 3.454400000000e-02 3.467100000000e-02 3.479800000000e-02 3.492500000000e-02 3.505200000000e-02 3.517900000000e-02 3.530600000000e-02 3.543300000000e-02 3.556000000000e-02 3.568700000000e-02 3.581400000000e-02 3.594100000000e-02 3.606800000000e-02 3.619500000000e-02 3.632200000000e-02 3.644900000000e-02 3.657600000000e-02 3.670300000000e-02 3.683000000000e-02 3.695700000000e-02 3.708400000000e-02 3.721100000000e-02 3.733800000000e-02 3.746500000000e-02 3.759200000000e-02 3.771900000000e-02 3.784600000000e-02 3.797300000000e-02 3.810000000000e-02 3.822700000000e-02 3.835400000000e-02 3.848100000000e-02 3.860800000000e-02 3.873500000000e-02 3.886200000000e-02 3.898900000000e-02 3.911600000000e-02 3.924300000000e-02 3.937000000000e-02 3.949700000000e-02 3.962400000000e-02 3.975100000000e-02 3.987800000000e-02 4.000500000000e-02 4.013200000000e-02 4.025900000000e-02 4.038600000000e-02 4.051300000000e-02 4.064000000000e-02 4.076700000000e-02 4.089400000000e-02 4.102100000000e-02 4.114800000000e-02 4.127500000000e-02 4.140200000000e-02 4.152900000000e-02 4.165600000000e-02 4.178300000000e-02 4.191000000000e-02 4.203700000000e-02 4.216400000000e-02 4.229100000000e-02 4.241800000000e-02 4.254500000000e-02 4.267200000000e-02 4.279900000000e-02 4.292600000000e-02 4.305300000000e-02 4.318000000000e-02 4.330700000000e-02 4.343400000000e-02 4.356100000000e-02 4.368800000000e-02 4.381500000000e-02 4.394200000000e-02 4.406900000000e-02 4.419600000000e-02 4.432300000000e-02 4.445000000000e-02 4.457700000000e-02 4.470400000000e-02 4.483100000000e-02 4.495800000000e-02 4.508500000000e-02 4.521200000000e-02 4.533900000000e-02 4.546600000000e-02 4.559300000000e-02 4.572000000000e-02 4.584700000000e-02 4.597400000000e-02 4.610100000000e-02 4.622800000000e-02 4.635500000000e-02 4.648200000000e-02 4.660900000000e-02 4.673600000000e-02 4.686300000000e-02 4.699000000000e-02 4.711700000000e-02 4.724400000000e-02 4.737100000000e-02 4.749800000000e-02 4.762500000000e-02 4.775200000000e-02 4.787900000000e-02 4.800600000000e-02 4.813300000000e-02 4.826000000000e-02 4.838700000000e-02 4.851400000000e-02 4.864100000000e-02 4.876800000000e-02 4.889500000000e-02 4.902200000000e-02 4.914900000000e-02 4.927600000000e-02 4.940300000000e-02 4.953000000000e-02 4.965700000000e-02 4.978400000000e-02 4.991100000000e-02 5.003800000000e-02 5.016500000000e-02 5.029200000000e-02 5.041900000000e-02 5.054600000000e-02 5.067300000000e-02 5.080000000000e-02 5.092700000000e-02 5.105400000000e-02 5.118100000000e-02 5.130800000000e-02 5.143500000000e-02 5.156200000000e-02 5.168900000000e-02 5.181600000000e-02 5.194300000000e-02 5.207000000000e-02 5.219700000000e-02 5.232400000000e-02 5.245100000000e-02 5.257800000000e-02 5.270500000000e-02 5.283200000000e-02 5.295900000000e-02 5.308600000000e-02 5.321300000000e-02 5.334000000000e-02 5.346700000000e-02 5.359400000000e-02 5.372100000000e-02 5.384800000000e-02 5.397500000000e-02 5.410200000000e-02 5.422900000000e-02 5.435600000000e-02 5.448300000000e-02 5.461000000000e-02 5.473700000000e-02 5.486400000000e-02 5.499100000000e-02 5.511800000000e-02 5.524500000000e-02 5.537200000000e-02 5.549900000000e-02 5.562600000000e-02 5.575300000000e-02 5.588000000000e-02 5.600700000000e-02 5.613400000000e-02 5.626100000000e-02 5.638800000000e-02 5.651500000000e-02 5.664200000000e-02 5.676900000000e-02 5.689600000000e-02 5.702300000000e-02 5.715000000000e-02 5.727700000000e-02 5.740400000000e-02 5.753100000000e-02 5.765800000000e-02 5.778500000000e-02 5.791200000000e-02 5.803900000000e-02 5.816600000000e-02 5.829300000000e-02 5.842000000000e-02 5.854700000000e-02 5.867400000000e-02 5.880100000000e-02 5.892800000000e-02 5.905500000000e-02 5.918200000000e-02 5.930900000000e-02 5.943600000000e-02 5.956300000000e-02 5.969000000000e-02 5.981700000000e-02 5.994400000000e-02 6.007100000000e-02 6.019800000000e-02 6.032500000000e-02 6.045200000000e-02 6.057900000000e-02 6.070600000000e-02 6.083300000000e-02 6.096000000000e-02 6.108700000000e-02 6.121400000000e-02 6.134100000000e-02 6.146800000000e-02 6.159500000000e-02 6.172200000000e-02 6.184900000000e-02 6.197600000000e-02 6.210300000000e-02 6.223000000000e-02 6.235700000000e-02 6.248400000000e-02 6.261100000000e-02 6.273800000000e-02 6.286500000000e-02 6.299200000000e-02 6.311900000000e-02 6.324600000000e-02 6.337300000000e-02 6.350000000000e-02 6.362700000000e-02 6.375400000000e-02 6.388100000000e-02 6.400800000000e-02 6.413500000000e-02 6.426200000000e-02 6.438900000000e-02 6.451600000000e-02 6.464300000000e-02 6.477000000000e-02 6.489700000000e-02 6.502400000000e-02 6.515100000000e-02 6.527800000000e-02 6.540500000000e-02 6.553200000000e-02 6.565900000000e-02 6.578600000000e-02 6.591300000000e-02 6.604000000000e-02 6.616700000000e-02 6.629400000000e-02 6.642100000000e-02 6.654800000000e-02 6.667500000000e-02 6.680200000000e-02 6.692900000000e-02 6.705600000000e-02 6.718300000000e-02 6.731000000000e-02 6.743700000000e-02 6.756400000000e-02 6.769100000000e-02 6.781800000000e-02 6.794500000000e-02 6.807200000000e-02 6.819900000000e-02 6.832600000000e-02 6.845300000000e-02 6.858000000000e-02 6.870700000000e-02 6.883400000000e-02 6.896100000000e-02 6.908800000000e-02 6.921500000000e-02 6.934200000000e-02 6.946900000000e-02 6.959600000000e-02 6.972300000000e-02 6.985000000000e-02 6.997700000000e-02 7.010400000000e-02 7.023100000000e-02 7.035800000000e-02 7.048500000000e-02 7.061200000000e-02 7.073900000000e-02 7.086600000000e-02 7.099300000000e-02 7.112000000000e-02 7.124700000000e-02 7.137400000000e-02 7.150100000000e-02 7.162800000000e-02 7.175500000000e-02 7.188200000000e-02 7.200900000000e-02 7.213600000000e-02 7.226300000000e-02 7.239000000000e-02 7.251700000000e-02 7.264400000000e-02 7.277100000000e-02 7.289800000000e-02 7.302500000000e-02 7.315200000000e-02 7.327900000000e-02 7.340600000000e-02 7.353300000000e-02 7.366000000000e-02 7.378700000000e-02 7.391400000000e-02 7.404100000000e-02 7.416800000000e-02 7.429500000000e-02 7.442200000000e-02 7.454900000000e-02 7.467600000000e-02 7.480300000000e-02 7.493000000000e-02 7.505700000000e-02 7.518400000000e-02 7.531100000000e-02 7.543800000000e-02 7.556500000000e-02 7.569200000000e-02 7.581900000000e-02 7.594600000000e-02 7.607300000000e-02 7.620000000000e-02 ];
fz_cm = fz*100;
%% Plotting



 lenvec = (1:length(att_curve))*7*2.54/length(att_curve);
 T = 293; %K
 P = 101300; %Pa
 R = 8.314; % J/K-mol
 W_Kr = 83.798*0.001; %kg/mol
 rho = P*W_Kr/(R*T); %kg/m^3
 X_Kr = 0.352
 MAC_Kr_60kVspec = 15.5/10;
 Tconvfun = @(att)  (P*W_Kr*X_Kr*MAC_Kr_60kVspec)./(att*100*R);
 tcurve_mat = fliplr(Tconvfun(att_curve_mat));
 tcurve_avg = fliplr(Tconvfun(mean(att_curve_mat(3:end,:),1)));

 tcurve_avg_ind = abs(tcurve_avg)<10000;
 tcurve_avg = tcurve_avg(tcurve_avg_ind);
 
 plotstyle = {'k--','b--','r--','g--','m--'}
figure
hold on
for ii = 1:5
 tcurve_sin = tcurve_mat(ii,:)
 tcurve_sin_ind = abs(tcurve_sin)<10000;
 tcurve_sin = tcurve_sin(tcurve_sin_ind);

  plot(lenvec(tcurve_sin_ind),smooth(tcurve_sin,1),plotstyle{ii})
legendInfo{ii} = ['Run ' num2str(ii)'];
end
plot(lenvec(tcurve_avg_ind),smooth(tcurve_avg,1),'k-')
legendInfo{ii+1} = 'Average';
hold off
title('PMB Temperature curves')
xlabel('x, cm')
ylabel('T, K')
legend(legendInfo)

%adjusting all for inlet temp
figure
hold on
for ii = 1:5
 tcurve_sin = tcurve_mat(ii,:);
 tcurve_sin_ind = abs(tcurve_sin)<10000;
 tcurve_sin = tcurve_sin(tcurve_sin_ind);

  plot(lenvec(tcurve_sin_ind),smooth(tcurve_sin,10)*300/tcurve_sin(1),plotstyle{ii})
legendInfo{ii} = ['Run ' num2str(ii)'];
end
plot(lenvec(tcurve_avg_ind),smooth(tcurve_avg,10)*300/tcurve_avg(1),'k-');
legendInfo{ii+1} = 'Average';
hold off
title('PMB Self-Calibrated Temperature Curves')
xlabel('x, cm')
ylabel('T, K')
legend(legendInfo)

figure
tcurve_sin = tcurve_mat(5,:)
 tcurve_sin_ind = abs(tcurve_sin)<10000;
  tcurve_sin = tcurve_sin(tcurve_sin_ind);
plot(lenvec(tcurve_sin_ind),smooth(tcurve_sin,3)*300/tcurve_sin(1),'k-',...
lenvec(tcurve_avg_ind),smooth(tcurve_avg,3)*300/tcurve_avg(1),'b-')
title('PMB Temperature Curves')
xlabel('x, cm')
ylabel('T, K')
legend('Run 5 of 5','Average')

figure
 subplot(1,2,1)
 hold on
 plot(smooth(tcurve_sin,5), lenvec(tcurve_sin_ind),'k-',...
 smooth(tcurve_sin,5)*300/tcurve_sin(1), lenvec(tcurve_sin_ind),'b-',...
 fT,fz_cm+3.7,'r-')
 xlabel('Temperature, K')
 ylabel('Z, cm')
 legend('Conversion','Self-Calibration','Model','Location','SouthEast')
 axis xy tight
 
 subplot(1,2,2)
 imagesc(squeeze(imgKr(:,192,1:end))')
 colormap(gray);
 axis off

 %mtit('Temperature Plots: Experiment Final Run, Model')
 

figure
 subplot(1,2,1)
 hold on
 plot(smooth(tcurve_sin,5)*300/tcurve_sin(1), lenvec(tcurve_sin_ind),'b-',...
 fT,fz_cm+3.7,'r-')
 xlabel('Temperature, K')
 ylabel('Z, cm')
 legend('Self-Calibration','Model','Location','SouthEast')
 axis xy tight
 
 subplot(1,2,2)
 imagesc(squeeze(imgKr(:,192,1:end))')
 colormap(gray);
 axis off

 %mtit('Temperature Plots: Experiment Final Run, Model')

 %%
 for i = 1:size(imgSub,3)
  Tmat(:,:,i) = Tconvfun(imgSub(:,:,i));
 end
 Tmat(Tmat>10000) = -10^9;
  Tmat(Tmat<0) = -10^9;
 figure
 burnleftind = 65;
 burnrightind = 318;
 burntopind = 235;
 burnbottomind = 357; 
 burnmidind = 293;
 range = [500 2500];
 ind = [burntopind burnmidind burnbottomind];
 name = 'filt2';
 filt = [2 2];
 
 cmaploc = hot;
figure;
slice = Tmat(:,:,ind(1));
slice( final(:,:,ind(1))) = 0;
slice = medfilt2(slice,filt);

imagesc(slice , range );
colormap(cmaploc);
colorbar
title('Attenuation Difference (Upper Slice)')
axis off
if saveind ==1
saveas(gca,strcat('topslice_',name),'jpg')
end

figure;
slice =  Tmat(:,:,ind(2));
slice( final(:,:,ind(2)) ) = 0;
slice = medfilt2(slice,filt);

imagesc(slice , range ); 
colormap(cmaploc);
colorbar
title('Attenuation Difference (Middle Slice)')
if saveind == 1
saveas(gca,strcat('topslice_',name),'jpg')
end

figure;
slice = medfilt2(Tmat(:,:,ind(3)),filt);
slice( final(:,:,ind(3)) ) = 0;
slice = medfilt2(slice,filt);

imagesc(slice , range );
colormap(cmaploc);
colorbar
title('Attenuation Difference (Lower Slice)')
if saveind ==1
saveas(gca,strcat('bottomslice_',name),'jpg')
end

hold on
figure
imagesc(imgKr(:,:,200) );
colormap(cmaploc);
colorbar
title('Box')
axis off

rectangle('position',[x(1) y(1) x(2)-x(1) y(2)-y(1)], ...
    'facecolor','b')
 
 
 
hold off
